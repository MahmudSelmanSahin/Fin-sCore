@page
@model SmsVerificationModel
@{
    ViewData["Title"] = "SMS Doğrulama";
}

<div class="sms-container">
    <div class="sms-card">
        <div class="sms-header">
            <button class="back-button" onclick="history.back()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h1 class="sms-title">SMS Doğrulama</h1>
            <p class="sms-subtitle">Size gönderilen 6 haneli doğrulama kodunu giriniz</p>
        </div>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-error" style="margin-bottom: 20px; padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; color: #991b1b; text-align: center;">
                @TempData["Error"]
            </div>
        }

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success" style="margin-bottom: 20px; padding: 12px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; color: #065f46; text-align: center;">
                @TempData["Success"]
            </div>
        }

        <form id="smsForm" class="sms-form" method="post" asp-page-handler="">
            <input type="hidden" id="identifier" name="identifier" value="@Model.Identifier" />

            <div class="sms-code-container">
                <div class="input-group">
                    <label class="input-label">Doğrulama Kodu</label>
                    <input type="text" 
                           id="otpCode" 
                           name="otpCode" 
                           class="form-input sms-single-input" 
                           placeholder="6 haneli kodu giriniz"
                           maxlength="6"
                           autocomplete="off"
                           required />
                    <span class="input-error" id="code_error"></span>
                </div>
            </div>

            <div class="sms-info">
                <p class="attempt-info">
                    <span id="attemptText">Kalan deneme hakkı: <strong>3</strong></span>
                </p>
                <button type="button" class="btn-link" id="resendBtn" style="display: none;">
                    Kodu Tekrar Gönder
                </button>
            </div>

            <button type="submit" class="btn-primary" id="verifyBtn">
                <span class="btn-text">Doğrula</span>
                <span class="btn-loader" style="display: none;">
                    <svg class="spinner" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
                        <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                    </svg>
                </span>
            </button>
        </form>

        <div class="sms-footer">
            <p>Kod gelmedi mi?</p>
            <div class="sms-alternatives">
                <form method="post" asp-page-handler="ResendOtp" style="display: inline;">
                    <input type="hidden" name="identifier" value="@Model.Identifier" />
                    <button type="submit" class="btn-link" id="resendLink">SMS'i Tekrar Gönder</button>
                </form>
                <span style="margin: 0 8px; color: #9ca3af;">veya</span>
                <button type="button" class="btn-link" id="emailOtpBtn">E-posta ile Gönder</button>
            </div>
        </div>

        @if (Model.OtpCode != null)
        {
            <div class="demo-otp-notice" style="margin-top: 20px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; text-align: center; font-size: 14px;">
                <strong>Demo:</strong> OTP Kodu: <code style="font-weight: bold; color: #0ea5e9;">@Model.OtpCode</code>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var $otp_input = $('#otpCode');
            var $sms_form = $('#smsForm');
            var $verify_btn = $('#verifyBtn');
            
            let attempt_count = 0;
            const max_attempts = 3;
            let resend_cooldown = 60;
            let resend_timer = null;

            // Focus input
            $otp_input.focus();

            // Only allow numbers
            $otp_input.on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                $(this).val(value);
                
                if (value.length === 6) {
                    $('#code_error').text('').removeClass('show');
                    $otp_input.removeClass('error');
                }
            });

            // Get attempt count from server
            var server_attempt_count = @(HttpContext.Session.GetInt32("OtpAttemptCount") ?? 0);
            attempt_count = server_attempt_count;

            // Update UI with server attempt count
            const remaining = max_attempts - attempt_count;
            if (remaining > 0) {
                $('#attemptText').html('Kalan deneme hakkı: <strong>' + remaining + '</strong>');
            } else {
                $('#attemptText').html('Deneme hakkınız doldu');
                $verify_btn.prop('disabled', true);
            }

            // Form submission
            $sms_form.on('submit', function(e) {
                e.preventDefault();

                const code = $otp_input.val();

                if (code.length !== 6) {
                    $('#code_error').text('Lütfen 6 haneli kodu giriniz').addClass('show');
                    $otp_input.addClass('error');
                    return;
                }

                // Check if already at max attempts
                if (attempt_count >= max_attempts) {
                    $('#code_error').text('Maksimum deneme hakkınız doldu. Ek güvenlik sayfasına yönlendiriliyorsunuz...').addClass('show');
                    setTimeout(function() {
                        window.location.href = '/AdditionalSecurity?identifier=' + encodeURIComponent($('#identifier').val());
                    }, 2000);
                    return;
                }

                // Show loading
                $verify_btn.addClass('loading');
                $verify_btn.find('.btn-text').hide();
                $verify_btn.find('.btn-loader').show();
                $verify_btn.prop('disabled', true);

                // Submit form to server
                $sms_form.off('submit').submit();
            });

            // Resend code
            function start_resend_cooldown() {
                resend_cooldown = 60;
                $('#resendLink, #resendBtn').prop('disabled', true);

                resend_timer = setInterval(function() {
                    resend_cooldown--;
                    if (resend_cooldown > 0) {
                        $('#resendLink, #resendBtn').text('Tekrar gönder (' + resend_cooldown + 's)');
                    } else {
                        clearInterval(resend_timer);
                        $('#resendLink, #resendBtn').prop('disabled', false).text('Tekrar gönder');
                    }
                }, 1000);
            }

            $('#resendBtn').on('click', function(e) {
                e.preventDefault();
                
                if ($(this).prop('disabled')) return;

                attempt_count = 0;
                $('#attemptText').html('Kalan deneme hakkı: <strong>3</strong>');
                $('#code_error').text('').removeClass('show');
                $otp_input.val('').removeClass('error').focus();
                $verify_btn.prop('disabled', false);

                start_resend_cooldown();
            });

            // Email OTP handler
            $('#emailOtpBtn').on('click', function(e) {
                e.preventDefault();
                alert('E-posta ile OTP gönderimi özelliği yakında eklenecek.');
            });

            // Initial cooldown
            start_resend_cooldown();
        });
    </script>
}


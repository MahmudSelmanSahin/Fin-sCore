@page
@model SmsVerificationModel
@{
    ViewData["Title"] = "SMS Doğrulama";
}

<div class="sms_container">
    <div class="sms_card">
        <div class="sms_header">
            <button class="back_button" onclick="history.back()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h1 class="sms_title">SMS Doğrulama</h1>
            <p class="sms_subtitle">Size gönderilen 6 haneli doğrulama kodunu giriniz</p>
        </div>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert_error">
                @TempData["Error"]
            </div>
        }

        @if (TempData["Success"] != null)
        {
            <div class="alert alert_success">
                @TempData["Success"]
            </div>
        }

        <form id="sms_form" class="sms_form" method="post" asp-page-handler="">
            <input type="hidden" id="identifier" name="identifier" value="@Model.Identifier" />

            <div class="sms_code_container">
                <div class="input_group">
                    <label class="input_label">Doğrulama Kodu</label>
                    <input type="text" 
                           id="otp_code" 
                           name="otpCode" 
                           class="form_input sms_single_input" 
                           placeholder="6 haneli kodu giriniz"
                           maxlength="6"
                           autocomplete="off"
                           required />
                    <span class="input_error" id="code_error"></span>
                </div>
            </div>

            <div class="sms_info">
                <p class="attempt_info">
                    <span id="attempt_text">Kalan deneme hakkı: <strong>3</strong></span>
                </p>
                <button type="button" class="btn_link hidden" id="resend_btn">
                    Kodu Tekrar Gönder
                </button>
            </div>

            <button type="submit" class="btn_primary" id="verify_btn">
                <span class="btn_text">Doğrula</span>
                <span class="btn_loader hidden">
                    <svg class="spinner" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
                        <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                    </svg>
                </span>
            </button>
        </form>

        <div class="sms_footer">
            <p>Kod gelmedi mi?</p>
            <div class="sms_alternatives">
                <form method="post" asp-page-handler="ResendOtp" class="inline_form">
                    <input type="hidden" name="identifier" value="@Model.Identifier" />
                    <button type="submit" class="btn_link" id="resend_link">SMS'i Tekrar Gönder</button>
                </form>
                <span class="separator">veya</span>
                <button type="button" class="btn_link" id="email_otp_btn">E-posta ile Gönder</button>
            </div>
        </div>

        @if (Model.OtpCode != null)
        {
            <div class="demo_otp_notice">
                <strong>Demo:</strong> OTP Kodu: <code class="otp_code">@Model.OtpCode</code>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var $otp_input = $('#otp_code');
            var $sms_form = $('#sms_form');
            var $verify_btn = $('#verify_btn');
            
            let attempt_count = 0;
            const max_attempts = 3;
            let resend_cooldown = 60;
            let resend_timer = null;

            // Focus input
            $otp_input.focus();

            // Only allow numbers
            $otp_input.on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 6) {
                    value = value.substring(0, 6);
                }
                $(this).val(value);
                
                if (value.length === 6) {
                    $('#code_error').text('').removeClass('show');
                    $otp_input.removeClass('error');
                }
            });

            // Get attempt count from server
            var server_attempt_count = @(HttpContext.Session.GetInt32("OtpAttemptCount") ?? 0);
            attempt_count = server_attempt_count;

            // Update UI with server attempt count
            const remaining = max_attempts - attempt_count;
            if (remaining > 0) {
                $('#attempt_text').html('Kalan deneme hakkı: <strong>' + remaining + '</strong>');
            } else {
                $('#attempt_text').html('Deneme hakkınız doldu');
                $verify_btn.prop('disabled', true);
            }

            // Form submission
            $sms_form.on('submit', function(e) {
                const code = $otp_input.val();

                if (code.length !== 6) {
                    e.preventDefault();
                    $('#code_error').text('Lütfen 6 haneli kodu giriniz').addClass('show');
                    $otp_input.addClass('error');
                    return false;
                }

                // Check if already at max attempts
                if (attempt_count >= max_attempts) {
                    e.preventDefault();
                    $('#code_error').text('Maksimum deneme hakkınız doldu. Ek güvenlik sayfasına yönlendiriliyorsunuz...').addClass('show');
                    setTimeout(function() {
                        window.location.href = '/AdditionalSecurity?identifier=' + encodeURIComponent($('#identifier').val());
                    }, 2000);
                    return false;
                }

                // Show loading
                $verify_btn.addClass('loading');
                $verify_btn.find('.btn_text').hide();
                $verify_btn.find('.btn_loader').removeClass('hidden').show();
                $verify_btn.prop('disabled', true);

                // Allow form to submit
                return true;
            });

            // Resend code
            function start_resend_cooldown() {
                resend_cooldown = 60;
                $('#resend_link, #resend_btn').prop('disabled', true);

                resend_timer = setInterval(function() {
                    resend_cooldown--;
                    if (resend_cooldown > 0) {
                        $('#resend_link, #resend_btn').text('Tekrar gönder (' + resend_cooldown + 's)');
                    } else {
                        clearInterval(resend_timer);
                        $('#resend_link, #resend_btn').prop('disabled', false).text('Tekrar gönder');
                    }
                }, 1000);
            }

            $('#resend_btn').on('click', function(e) {
                e.preventDefault();
                
                if ($(this).prop('disabled')) return;

                attempt_count = 0;
                $('#attempt_text').html('Kalan deneme hakkı: <strong>3</strong>');
                $('#code_error').text('').removeClass('show');
                $otp_input.val('').removeClass('error').focus();
                $verify_btn.prop('disabled', false);

                start_resend_cooldown();
            });

            // Email OTP handler
            $('#email_otp_btn').on('click', function(e) {
                e.preventDefault();
                alert('E-posta ile OTP gönderimi özelliği yakında eklenecek.');
            });

            // Initial cooldown
            start_resend_cooldown();
        });
    </script>
}
